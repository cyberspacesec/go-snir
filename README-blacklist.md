# URL黑名单功能

URL黑名单功能是go-snir的一项重要安全特性，用于防止工具被滥用来扫描或访问敏感内网资源、云服务元数据API或其他不应被访问的资源。

## 工作原理

黑名单系统通过多种方式检查URL是否应该被阻止：

1. **CIDR网络检查**：阻止对特定IP范围的访问（如内网地址：10.0.0.0/8, 192.168.0.0/16等）
2. **精确IP匹配**：阻止对特定IP地址的访问（如云服务元数据地址：169.254.169.254）
3. **域名匹配**：阻止对特定域名的访问
4. **正则表达式匹配**：通过模式匹配阻止特定类型的URL
5. **端口匹配**：阻止访问特定端口的服务
6. **DNS解析检查**：将域名解析为IP后检查是否在黑名单范围内

## 默认黑名单规则

系统默认包含以下类型的黑名单规则：

1. **本地和内网地址**：
   - localhost
   - 127.0.0.0/8（本地环回）
   - 10.0.0.0/8、172.16.0.0/12、192.168.0.0/16（RFC1918私有地址）
   - 169.254.0.0/16（链路本地地址）
   - fc00::/7（IPv6唯一本地地址）

2. **云服务元数据地址**：
   - 169.254.169.254（AWS/GCP/Digital Ocean元数据服务）
   - metadata.google.internal（GCP）
   - metadata.internal（Digital Ocean）
   - metadata.service（Azure）

3. **敏感内部服务**：
   - consul.service.consul
   - vault.service.consul

4. **数据库和缓存服务默认端口**：
   - .*:1433（MSSQL）
   - .*:3306（MySQL）
   - .*:5432（PostgreSQL）
   - .*:6379（Redis）
   - .*:27017（MongoDB）
   - .*:9200（Elasticsearch）
   - .*:11211（Memcached）

5. **危险协议**：
   - file://.*
   - ftp://.*

## 配置方法

黑名单功能是在**服务器级别**配置的，不能在单个API请求中修改。这是出于安全考虑，防止攻击者通过API请求绕过黑名单保护。

### 命令行参数

在启动go-snir API服务时，你可以使用以下参数配置黑名单：

```bash
# 启用黑名单功能（默认开启）
go-snir api --enable-blacklist=true

# 使用默认黑名单规则（默认开启）
go-snir api --default-blacklist=true

# 添加自定义黑名单规则（可多次使用）
go-snir api --blacklist-pattern="internal.example.com" --blacklist-pattern="192.168.10.0/24"

# 从文件加载黑名单规则
go-snir api --blacklist-file="/path/to/blacklist.txt"
```

### 黑名单文件格式

黑名单文件是一个文本文件，每行包含一个规则：

```
# 这是注释行
# IP地址
192.168.1.1
# CIDR范围
10.0.0.0/8
# 域名
internal.example.com
# 正则表达式
.*:8080
```

空行和以`#`开头的行将被忽略。

## 安全考虑

1. **永远不要禁用黑名单功能**：黑名单是一项重要的安全机制，用于防止工具被用于未授权访问内部资源。
   
2. **定期更新黑名单**：随着新的安全风险被发现，应定期更新黑名单规则。

3. **自定义规则**：针对您的环境添加额外的黑名单规则，例如您组织的内部域名和IP范围。

4. **多层防御**：黑名单是重要的安全层，但不应该是唯一的保护措施。还应该使用网络隔离、防火墙规则等其他安全控制。

## 常见问题

### 如何检查URL是否在黑名单中？

当go-snir尝试访问一个URL时，它会自动检查该URL是否在黑名单中。如果URL被列入黑名单，go-snir将记录一条警告消息并拒绝访问。

### 如何添加临时例外？

黑名单功能是全局性的，不支持临时例外。如果您需要访问被黑名单阻止的资源，您需要修改黑名单配置并重新启动服务。

### 如何解决误报？

如果合法的URL被黑名单误报，您可以通过自定义黑名单规则来解决这个问题，同时保持默认规则启用：

```bash
go-snir api --default-blacklist=true --blacklist-pattern="!specific-allowed-internal.example.com"
```

前缀`!`表示该规则是允许规则而非阻止规则。

## 日志和监控

当URL被黑名单阻止时，go-snir会记录一条警告级别的日志消息，包含被阻止的URL和阻止原因。

```
WARN 跳过黑名单URL url=http://169.254.169.254/metadata reason="IP地址在黑名单CIDR范围内: 169.254.0.0/16"
```

建议您监控这些日志消息，特别是在生产环境中，以检测潜在的恶意活动。 